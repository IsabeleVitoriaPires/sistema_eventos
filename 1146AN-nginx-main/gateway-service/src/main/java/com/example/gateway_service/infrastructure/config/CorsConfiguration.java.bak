package com.example.gateway_service.infrastructure.config;

import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.web.cors.CorsConfigurationSource;
import org.springframework.web.cors.reactive.CorsWebFilter;
import org.springframework.web.cors.reactive.UrlBasedCorsConfigurationSource;

import java.util.Arrays;
import java.util.Collections;

/**
 * CORS Configuration for Spring Cloud Gateway
 * Allows frontend (localhost:3000) to access backend APIs
 */
@Configuration
public class CorsConfiguration {

    @Bean
    public CorsWebFilter corsWebFilter() {
        org.springframework.web.cors.CorsConfiguration corsConfig = new org.springframework.web.cors.CorsConfiguration();

        // Allow all origins for development
        // Note: Using setAllowedOrigins with "*" instead of patterns
        // This disables credentials but works with file:// protocol
        corsConfig.addAllowedOrigin("*");

        // Allow all HTTP methods
        corsConfig.addAllowedMethod("*");

        // Allow all headers
        corsConfig.addAllowedHeader("*");

        // Disable credentials for development (required when using "*" origin)
        corsConfig.setAllowCredentials(false);

        // Cache preflight response for 1 hour
        corsConfig.setMaxAge(3600L);

        // Expose headers that frontend can read
        corsConfig.addExposedHeader("Authorization");

        UrlBasedCorsConfigurationSource source = new UrlBasedCorsConfigurationSource();
        source.registerCorsConfiguration("/**", corsConfig);

        return new CorsWebFilter(source);
    }
}
